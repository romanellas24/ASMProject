<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Ordini di Oggi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding-top: 2rem;
      background-color: #f8f9fa;
    }
    .dish-item {
      margin-left: 1rem;
      font-size: 0.95rem;
    }
    .action-button-container {
      text-align: right;
      margin-top: 1rem;
      min-height: 40px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Ordini del Giorno</h2>
    <div>
      <a href="/" class="btn btn-outline-primary me-2">Torna alla Home</a>
      <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="authWarning" class="alert alert-warning d-none">
    ⚠️ Non sei loggato: gli ordini non verranno aggiornati automaticamente in tempo reale.
  </div>

  <div id="ordersList" class="list-group mb-4">
  </div>

  <nav>
    <ul class="pagination justify-content-center">
      <li class="page-item"><button class="page-link" id="prevPage">Precedente</button></li>
      <li class="page-item disabled"><span class="page-link" id="currentPageDisplay">Pagina 1</span></li>
      <li class="page-item"><button class="page-link" id="nextPage">Successiva</button></li>
    </ul>
  </nav>
</div>

<template id="order-template">
  <div class="list-group-item">
    <h5>Ordine #<span class="order-id"></span></h5>
    <p><strong>Consegna:</strong> <span class="delivery-time"></span></p>
    <div><strong>Piatti:</strong><div class="dishes-html"></div></div>
    <p class="mt-2"><strong>Totale:</strong> €<span class="total-price"></span></p>
    <div class="action-button-container">
    </div>
  </div>
</template>

<script>
  const BASE_URL = "[[${beUrl}]]";
  const WS_URL = "wss://" + BASE_URL + "/ws";
  const API_URL = "https://" + BASE_URL + "/api";
  let jwt = localStorage.getItem("jwt");
  let socket;
  let heartbeatInterval;
  const authWarning = document.getElementById('authWarning');

  if (!jwt) {
    authWarning.classList.remove("d-none");
  } else {
    socket = new WebSocket(WS_URL + "?token=" + jwt);

    socket.onopen = function() {
      heartbeatInterval = setInterval(() => {
        if (socket.readyState === WebSocket.OPEN) {
          socket.send("ping");
        }
      }, 10000);
      const command = {
        command: "GET_ORDERS",
        payload: {}
      };

      try {
        socket.send(JSON.stringify(command));
        console.log("Comando inviato via WebSocket:", command);
      } catch (error) {
        console.error("Impossibile inviare comando via WebSocket:", error);
      }
    };

    socket.onmessage = async function(messageEvent) {
      if (messageEvent.data === "pong") return;

      try {
        const event = JSON.parse(messageEvent.data);
        console.log("Evento ricevuto:", event);

        switch (event.eventType) {
          case "ORDER_CAN_START":
            activateOrderTask(event.payload.tasks);
            break;
          case "ORDER_TODO":
            handleNewOrUpdatedOrder(event.payload.order);
            break;
          case "ORDER_DELETED":
            removeOrderCardById(event.payload.orderId);
            break;
          case "ORDER_TIMED_OUT":
            removeOrderCardById(event.payload.orderId, true);
            break;
          default:
            console.warn("Tipo di evento non gestito:", event.eventType);
        }
      } catch (err) {
        console.error("Errore durante la gestione del messaggio WebSocket:", err);
      }
    };

    socket.onclose = function() {
      clearInterval(heartbeatInterval);
    };
  }

  let currentPage = 0;
  let currentOrders = [];
  const ordersPerPage = 9;

  function handleNewOrUpdatedOrder(newOrder) {
    if (!newOrder || typeof newOrder.id === 'undefined') return;

    const existingIndex = currentOrders.findIndex(o => o.id === newOrder.id);
    if (existingIndex !== -1) {
      currentOrders[existingIndex] = newOrder;
    } else {
      currentOrders.push(newOrder);
    }
    renderOrders();
  }

  function activateOrderTask(tasks) {
    for(let task of tasks){
      if (!task || !task.orderData) return;
      const orderId = task.orderData.id;
      const card = document.querySelector(`.list-group-item[data-order-id='${orderId}']`);
      if (!card) {
        console.warn(`Card per ordine #${orderId} non trovata, impossibile attivarla.`);
        return;
      }

      card.dataset.taskId = task.taskId;
      card.classList.add('border-primary', 'border-2');

      const actionContainer = card.querySelector('.action-button-container');
      actionContainer.innerHTML = '';

      const button = document.createElement('button');
      button.className = 'btn btn-primary btn-sm';
      button.textContent = 'Ordine Preparato';
      button.onclick = () => sendTaskCompleted(task.taskId);
      actionContainer.appendChild(button);
    }
  }

  function renderOrders() {
    const seen = new Set();
    currentOrders = currentOrders.filter(order => {
      if (order && typeof order.id !== 'undefined' && !seen.has(order.id)) {
        seen.add(order.id);
        return true;
      }
      return false;
    });

    currentOrders.sort((a, b) => new Date(a.deliveryTime) - new Date(b.deliveryTime));

    const list = document.getElementById('ordersList');
    list.innerHTML = '';

    const start = currentPage * ordersPerPage;
    const end = start + ordersPerPage;
    const pageOrders = currentOrders.slice(start, end);

    if (pageOrders.length === 0 && currentPage > 0) {
      currentPage--;
      renderOrders();
      return;
    }

    pageOrders.forEach(order => {
      const template = document.getElementById('order-template').content.cloneNode(true);
      const item = template.querySelector('.list-group-item');

      item.dataset.orderId = order.id;
      if (order.taskId) {
        item.dataset.taskId = order.taskId;
      }

      item.querySelector('.order-id').textContent = order.id;
      item.querySelector('.delivery-time').textContent = new Date(order.deliveryTime).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
      item.querySelector('.total-price').textContent = order.totalPrice.toFixed(2);

      const dishesHtmlContainer = item.querySelector('.dishes-html');
      if(order.dishes && Array.isArray(order.dishes)) {
        const dishesHtml = order.dishes.map(d => `
          <div class="dish-item">
            <strong>${d.quantity}x</strong> ${d.dish.name} -
            <em>${d.dish.description}</em>
            <span class="text-muted">(${(d.dish.price * d.quantity).toFixed(2)}€)</span>
          </div>
        `).join('');
        dishesHtmlContainer.innerHTML = dishesHtml;
      }

      const actionContainer = item.querySelector('.action-button-container');
      if (order.taskId) {
        const button = document.createElement('button');
        button.className = 'btn btn-primary btn-sm';
        button.textContent = 'Ordine Preparato';
        button.onclick = () => sendTaskCompleted(order.taskId);
        actionContainer.innerHTML = '';
        actionContainer.appendChild(button);
      }

      list.appendChild(template);
    });

    document.getElementById('currentPageDisplay').textContent = `Pagina ${currentPage + 1}`;
    document.getElementById('prevPage').disabled = currentPage === 0;
    document.getElementById('nextPage').disabled = end >= currentOrders.length;
  }

  function sendTaskCompleted(taskId) {
    if (!taskId) {
      console.error("ID del Task mancante per 'Ordine Preparato'");
      return;
    }
    const command = {
      command: "COMPLETE_TASK_PREPARED",
      payload: { taskId: taskId }
    };
    try {
      socket.send(JSON.stringify(command));
      const card = document.querySelector(`.list-group-item[data-task-id='${taskId}']`);
      if (card) {
        const orderIdToRemove = parseInt(card.dataset.orderId);
        currentOrders = currentOrders.filter(o => o.id !== orderIdToRemove);
        renderOrders();
      }
    } catch (error) {
      console.error("Errore invio comando 'Ordine Preparato':", error);
    }
  }

  async function loadOrders() {
    try {
      const res = await fetch(`${API_URL}/order?page=${currentPage}`);
      if (!res.ok) throw new Error("Errore nel caricamento degli ordini");
      const newOrders = await res.json();

      if (currentPage === 0) {
        currentOrders = newOrders;
      } else {
        newOrders.forEach(newOrder => {
          const existingIndex = currentOrders.findIndex(o => o.id === newOrder.id);
          if (existingIndex === -1) {
            currentOrders.push(newOrder);
          }
        });
      }
      renderOrders();
    } catch (error) {
      console.error(error);
      document.getElementById('ordersList').innerHTML =
              '<div class="alert alert-danger">Errore durante il caricamento degli ordini.</div>';
    }
  }

  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 0) {
      currentPage--;
      renderOrders();
    }
  });

  document.getElementById('nextPage').addEventListener('click', () => {
    const isLastPage = (currentPage + 1) * ordersPerPage >= currentOrders.length;
    if(!document.getElementById('nextPage').disabled){
      currentPage++;
      loadOrders();
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    loadOrders();
  });

  function removeOrderCardById(orderId) {
    const initialLength = currentOrders.length;
    currentOrders = currentOrders.filter(order => order.id !== orderId);
    if (currentOrders.length < initialLength) {
      renderOrders();
    }
  }

  function logout() {
    localStorage.removeItem("jwt");
    if (socket) socket.close();
    window.location.href = "/auth/login";
  }
</script>

</body>
</html>