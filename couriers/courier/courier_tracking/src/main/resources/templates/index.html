<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Courier Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card-custom {
            max-width: 700px;
            margin: auto;
            margin-top: 50px;
            border-radius: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .btn-primary {
            margin-top: 20px;
        }

        #customMsg h2, #customMsg h3 {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card card-custom p-4">
        <h1 class="text-center mb-4">Benvenuto, corriere <span th:text="${courier_id}">[courier_id]</span>!</h1>
        <div id="customMsg" class="text-center">
            <h2>Non ci sono consegne da effettuare!</h2>
        </div>
    </div>
</div>

<!-- WebSocket + Logic -->
<script th:inline="javascript">
    const COURIER_ID = [[${courier_id}]];
    const WSURL = [[${WSurl}]];
    const DEFMSG = "<h2>Non ci sono consegne da effettuare!</h2>";
    let webSocket = {};

    function deleteOrderHTML(orderId) {
        document.getElementById("customMsg").innerHTML = DEFMSG;
        const message = JSON.stringify({
            "orderId": orderId,
            "courierId": COURIER_ID,
            "delivered": true,
        });
        webSocket.send(message);
    }

    function insertOrderHTML(orderId) {
        const msg = `<h2>Hai una nuova consegna (ID: ${orderId})!</h2>
                     <p>Quando hai completato la consegna, premi il bottone qui sotto.</p>`;
        const btn = `<button class="btn btn-primary" onclick="deleteOrderHTML(${orderId})">Consegnato</button>`;
        document.getElementById("customMsg").innerHTML = msg + btn;
    }

    function errorHTML(error) {
        document.getElementById("customMsg").innerHTML = `<div class="alert alert-danger">
            <strong>Errore:</strong> ${error}
            <br><small>Ricarica la pagina per riprovare.</small>
        </div>`;
    }

    const connectWS = () => {
        webSocket = new WebSocket(WSURL + "/notification?courierId=" + COURIER_ID);
        console.log("WSURL: " + WSURL + "/notification?courierId=" + COURIER_ID);
        console.log("connected to ws;")
    }

    connectWS();

    webSocket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            console.log(data);
            if (data.type === 'ERROR') {
                console.error("Errore:", data.message);
                errorHTML(data.message);
            } else {
                insertOrderHTML(data.orderId);
            }
        } catch (e) {
            console.error("Errore di parsing:", e);
            console.log(event.data);
        }
    };

    webSocket.onerror = (event) => {
        console.error("Errore WebSocket:", event);
        errorHTML("Errore di comunicazione con il server WebSocket.");
    };
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

</body>
</html>
