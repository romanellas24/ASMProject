@startuml
title Blocco Rimborso Token - Flusso richiesta/risposta
hide footbox

actor "Utente (Acmeat)" as User
participant "Edge Gateway" as EdgeGW
participant "API Gateway (REST)" as APIGW
participant "Payment Service" as PaySvc
database "DB" as DB

== Invio richiesta ==
User -> EdgeGW: PUT /payments/{token}/notRefound
activate EdgeGW

EdgeGW -> APIGW: PUT /payments/{token}/notRefound
activate APIGW

APIGW -> PaySvc: PUT /payments/{token}/notRefound
activate PaySvc

== Verifica stato token ==
PaySvc -> DB: MySql Query (read token)
activate DB
DB --> PaySvc: Mysql ResultSet
deactivate DB

alt [token trovato e pagato]
    == Blocco rimborso ==
    PaySvc -> DB: MySql Query (block refund)
    activate DB
    DB --> PaySvc: Mysql Result (blocked)
    deactivate DB

    == Invio della risposta ==
    PaySvc --> APIGW: { state: "Blocked" }
    deactivate PaySvc

    APIGW --> EdgeGW: { state: "Blocked" }
    deactivate APIGW

    EdgeGW --> User: { state: "Blocked" }
    deactivate EdgeGW

else [token trovato ma non pagato]
    == Invio della risposta ==
    PaySvc --> APIGW: { state: "Not paid" }
    deactivate PaySvc

    APIGW --> EdgeGW: { state: "Not paid" }
    deactivate APIGW

    EdgeGW --> User: { state: "Not paid" }
    deactivate EdgeGW

else [token non trovato]
    == Invio della risposta ==
    PaySvc --> APIGW: { state: "Not found" }
    deactivate PaySvc

    APIGW --> EdgeGW: { state: "Not found" }
    deactivate APIGW

    EdgeGW --> User: { state: "Not found" }
    deactivate EdgeGW
end
@enduml
