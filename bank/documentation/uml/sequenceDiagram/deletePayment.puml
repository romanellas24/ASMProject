@startuml
title Rimborso Token - Flusso richiesta/risposta
hide footbox

actor "Utente (Acmeat)" as User
participant "Edge Gateway" as EdgeGW
participant "API Gateway (REST)" as APIGW
participant "Payment Service" as PaySvc
database "DB" as DB

== Invio richiesta ==
User -> EdgeGW: DELETE /payments/{token}
activate EdgeGW

EdgeGW -> APIGW: DELETE /payments/{token}
activate APIGW

APIGW -> PaySvc: DELETE /payments/{token}
activate PaySvc

== Verifica stato token ==
PaySvc -> DB: MySql Query (read token)
activate DB
DB --> PaySvc: Mysql ResultSet
deactivate DB

alt [token trovato e pagato]
    == Elaborazione rimborso ==
    PaySvc -> DB: MySql Query (delete/refund token)
    activate DB
    DB --> PaySvc: Mysql Result (deleted)
    deactivate DB

    == Invio della risposta ==
    PaySvc --> APIGW: { state: "Deleted" }
    deactivate PaySvc

    APIGW --> EdgeGW: { state: "Deleted" }
    deactivate APIGW

    EdgeGW --> User: { state: "Deleted" }
    deactivate EdgeGW

else [token trovato ma non pagato]
    == Invio della risposta ==
    PaySvc --> APIGW: { state: "Not paid" }
    deactivate PaySvc

    APIGW --> EdgeGW: { state: "Not paid" }
    deactivate APIGW

    EdgeGW --> User: { state: "Not paid" }
    deactivate EdgeGW

else [token non trovato]
    == Invio della risposta ==
    PaySvc --> APIGW: { state: "Not found" }
    deactivate PaySvc

    APIGW --> EdgeGW: { state: "Not found" }
    deactivate APIGW

    EdgeGW --> User: { state: "Not found" }
    deactivate EdgeGW
end
@enduml
